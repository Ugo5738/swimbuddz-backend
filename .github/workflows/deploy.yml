name: Backend CI/CD Pipeline

on:
  push:
    branches: ["main", "master", "staging", "develop"]
  pull_request:
    branches: ["main", "master", "staging", "develop"]

env:
  DOCKER_REGISTRY: docker.io
  DOCKER_USERNAME: ${{ secrets.DOCKER_USERNAME }}
  DEPLOY_PATH: /home/deploy/swimbuddz-backend
  # Prefer to set REPO_URL as a secret that already includes auth (e.g., https://<token>@github.com/Ugo5738/swimbuddz-backend.git)
  REPO_URL: ${{ secrets.REPO_URL }}
  GPG_PASSPHRASE: ${{ secrets.ENV_FILE_GPG_PASSPHRASE }}

jobs:
  # ------------------------------------------------------------------
  # BACKEND CI
  # ------------------------------------------------------------------
  backend-ci:
    runs-on: ubuntu-latest

    env:
      # Set a dummy DATABASE_URL for tests (tests don't actually connect)
      DATABASE_URL: postgresql+psycopg://test:test@localhost:5432/test_db

    steps:
      - uses: actions/checkout@v4

      - name: Set up Python 3.11
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"
          cache: "pip"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e ".[dev]"

      - name: Lint with Ruff
        run: |
          ruff check .
          ruff format --check .

      - name: Run Tests
        run: |
          pytest tests/

  # ------------------------------------------------------------------
  # BUILD AND PUSH DOCKER IMAGES
  # ------------------------------------------------------------------
  build-and-push:
    needs: [backend-ci]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master' || github.ref == 'refs/heads/staging')
    strategy:
      fail-fast: false
      matrix:
        include:
          - context: .
            dockerfile: ./services/academy_service/Dockerfile
            image: swimbuddz-academy-service
          - context: .
            dockerfile: ./services/attendance_service/Dockerfile
            image: swimbuddz-attendance-service
          - context: .
            dockerfile: ./services/communications_service/Dockerfile
            image: swimbuddz-communications-service
          - context: .
            dockerfile: ./services/events_service/Dockerfile
            image: swimbuddz-events-service
          - context: .
            dockerfile: ./services/gateway_service/Dockerfile
            image: swimbuddz-gateway-service
          - context: .
            dockerfile: ./services/media_service/Dockerfile
            image: swimbuddz-media-service
          - context: .
            dockerfile: ./services/members_service/Dockerfile
            image: swimbuddz-members-service
          - context: .
            dockerfile: ./services/payments_service/Dockerfile
            image: swimbuddz-payments-service
          - context: .
            dockerfile: ./services/sessions_service/Dockerfile
            image: swimbuddz-sessions-service
          - context: .
            dockerfile: ./services/store_service/Dockerfile
            image: swimbuddz-store-service
          - context: .
            dockerfile: ./services/transport_service/Dockerfile
            image: swimbuddz-transport-service
          - context: .
            dockerfile: ./services/ai_service/Dockerfile
            image: swimbuddz-ai-service

    steps:
      - uses: actions/checkout@v4

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      - name: Extract metadata (tags, labels) for Docker
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.DOCKER_USERNAME }}/${{ matrix.image }}
          tags: |
            type=raw,value=latest
            type=sha,prefix=,format=long

      - name: Build and push Docker image
        uses: docker/build-push-action@v5
        with:
          context: ${{ matrix.context }}
          file: ${{ matrix.dockerfile }}
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

  # ------------------------------------------------------------------
  # DEPLOY TO DIGITAL OCEAN
  # ------------------------------------------------------------------
  deploy:
    needs: [build-and-push]
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && (github.ref == 'refs/heads/main' || github.ref == 'refs/heads/master')

    steps:
      - name: Deploy to Digital Ocean
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST }}
          username: ${{ secrets.DO_USERNAME }}
          key: ${{ secrets.DO_SSH_KEY }}
          command_timeout: 30m
          envs: GPG_PASSPHRASE
          script: |
            set -euo pipefail
            set -x

              # Ensure project directory exists
              mkdir -p "${{ env.DEPLOY_PATH }}"
              cd "${{ env.DEPLOY_PATH }}"

              # Clone repo if missing, otherwise fetch/reset to main
              if [ ! -d .git ]; then
                git clone "${{ env.REPO_URL }}" .
              else
                git remote set-url origin "${{ env.REPO_URL }}"
                git fetch origin
                git reset --hard origin/main
              fi

              # Decrypt .env.prod from repository (requires .env.prod.gpg and GPG_PASSPHRASE)
              if [ ! -f .env.prod.gpg ]; then
                echo "Missing .env.prod.gpg in repo. Aborting deploy." >&2
                exit 1
              fi
              if [ -z "${GPG_PASSPHRASE:-}" ]; then
                echo "GPG_PASSPHRASE not set. Aborting deploy." >&2
                exit 1
              fi
              echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 -o .env.prod -d .env.prod.gpg

              # Make DOCKER_USERNAME and LE_EMAIL available for compose
              export DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
              export LE_EMAIL="${{ secrets.LE_EMAIL }}"
              # Explicitly target a recent Docker API to satisfy the engine minimum supported version
              export DOCKER_API_VERSION="1.52"

              # Login to Docker Hub (to ensure we can pull private images if needed)
              echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

              # Ensure external network exists for Traefik routing
              docker network inspect swimbuddz_proxy >/dev/null 2>&1 || docker network create swimbuddz_proxy

              # Prepare Traefik ACME storage (Let’s Encrypt)
              mkdir -p letsencrypt
              touch letsencrypt/acme.json
              chmod 600 letsencrypt/acme.json

              # Pull latest images
              echo "==> pulling images"
              COMPOSE_HTTP_TIMEOUT=600 docker compose -f docker-compose.prod.yml pull --no-parallel

              # Apply migrations (production-safe)
              echo "==> running migrations"
              COMPOSE_HTTP_TIMEOUT=600 docker compose -f docker-compose.prod.yml run --rm --no-deps gateway ./scripts/db/migrate-prod.sh --all .env.prod

              # Restart services
              echo "==> bringing up services"
              COMPOSE_HTTP_TIMEOUT=600 docker compose -f docker-compose.prod.yml up -d --wait

              # Cleanup unused images
              echo "==> pruning images"
              docker image prune -f

  # ------------------------------------------------------------------
  # DEPLOY TO STAGING (NO PROD IMPACT)
  # ------------------------------------------------------------------
  deploy-staging:
    needs: [build-and-push]
    runs-on: ubuntu-latest
    # if: github.event_name == 'push' && github.ref == 'refs/heads/staging'
    if: false # Disabled until staging server is provisioned

    steps:
      - name: Deploy to Staging (Digital Ocean)
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.DO_HOST_STAGING }}
          username: ${{ secrets.DO_USERNAME_STAGING }}
          key: ${{ secrets.DO_SSH_KEY_STAGING }}
          command_timeout: 30m
          envs: GPG_PASSPHRASE
          script: |
            set -euo pipefail
            set -x

              # Ensure project directory exists
              mkdir -p "${{ env.DEPLOY_PATH }}"
              cd "${{ env.DEPLOY_PATH }}"

              # Clone repo if missing, otherwise fetch/reset to staging
              if [ ! -d .git ]; then
                git clone "${{ env.REPO_URL }}" .
              else
                git remote set-url origin "${{ env.REPO_URL }}"
                git fetch origin
                git reset --hard origin/staging
              fi

              # Decrypt .env.prod.gpg into .env.prod (staging env file encrypted separately)
              if [ ! -f .env.prod.gpg ]; then
                echo "Missing .env.prod.gpg in repo. Aborting deploy." >&2
                exit 1
              fi
              if [ -z "${GPG_PASSPHRASE:-}" ]; then
                echo "GPG_PASSPHRASE not set. Aborting deploy." >&2
                exit 1
              fi
              echo "$GPG_PASSPHRASE" | gpg --batch --yes --passphrase-fd 0 -o .env.prod -d .env.prod.gpg

              # Make DOCKER_USERNAME and LE_EMAIL available for compose
              export DOCKER_USERNAME="${{ secrets.DOCKER_USERNAME }}"
              export LE_EMAIL="${{ secrets.LE_EMAIL }}"
              export DOCKER_API_VERSION="1.52"

              # Login to Docker Hub
              echo "${{ secrets.DOCKER_PASSWORD }}" | docker login -u "${{ secrets.DOCKER_USERNAME }}" --password-stdin

              # Ensure external network exists for Traefik routing
              docker network inspect swimbuddz_proxy >/dev/null 2>&1 || docker network create swimbuddz_proxy

              # Prepare Traefik ACME storage (Let’s Encrypt)
              mkdir -p letsencrypt
              touch letsencrypt/acme.json
              chmod 600 letsencrypt/acme.json

              # Pull latest images
              echo "==> pulling images"
              COMPOSE_HTTP_TIMEOUT=600 docker compose -f docker-compose.prod.yml pull --no-parallel

              # Restart services
              echo "==> bringing up services"
              COMPOSE_HTTP_TIMEOUT=600 docker compose -f docker-compose.prod.yml up -d --wait

              # Cleanup unused images
              echo "==> pruning images"
              docker image prune -f

# base64 -i .env.prod | pbcopy
# Paste the output directly into the secret value ENV_FILE_PROD_BASE64.

# PASSPHRASE='swimbuddz'; \
# printf '%s' "$PASSPHRASE" | gpg --batch --yes --pinentry-mode loopback --passphrase-fd 0 --symmetric --cipher-algo AES256 .env.prod
# unset PASSPHRASE
